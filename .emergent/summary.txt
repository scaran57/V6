<analysis>
The AI engineer's work evolved the score prediction app from a basic MVP to a sophisticated system. Initial efforts fixed OCR caching with image hashes and improved frontend routing. A significant phase implemented a unified league coefficient system, scraping data for national and European leagues, calculating team coefficients, and scheduling automatic updates. Prediction validation was integrated, and the UI was updated. The system was then audited and stabilized. Subsequent work focused on migrating and unifying the learning system, creating a new UFA architecture for league-specific training, and developing advanced OCR for automatic real-score input with fuzzy team/league detection and immediate auto-training. The core challenge was ensuring learning consistency across different prediction modes and accurately migrating historical data.
</analysis>

<product_requirements>
The application's core function is to predict scores from bookmaker images using OCR, adaptive algorithms, and dynamic learning. The user requested: clear UI display of match info with manual input fallback; a secure, atomic learning system with an append-only log; a  endpoint with cache controls and  for uniqueness; a league coefficient system with daily updates, European league expansion, and fallback logic; a prediction validation system with frontend display; a full system audit and documentation. Most recently, the user requested integrating additional European leagues, unifying the Phase 1 and Phase 2 league systems, migrating existing real scores to a new UFA learning architecture, and implementing an OCR-based auto-importer for real scores with team/league detection and immediate auto-training.
</product_requirements>

<key_technical_concepts>
-   **FastAPI & React:** Core backend and frontend.
-   **PyTesseract & PIL:** OCR and image processing.
-   **Adaptive Learning (diffExpected & UFA):** Global and league-specific model refinement.
-   **Analysis Cache:** Stores match data, secured by .
-   **League Coefficient System:** Dynamic adjustment of prediction odds.
-   **Prediction Validation:** Measures model accuracy.
-   **Beautiful Soup & Requests:** Web scraping.
-   **APScheduler:** Background task management.
-   **FuzzyWuzzy:** Fuzzy string matching for team detection.
</key_technical_concepts>

<code_architecture>
The application uses a FastAPI backend and a React frontend within a Dockerized environment, managed by Supervisor.



**Key Files and Changes:**

-   : Central FastAPI app. Routes added for unified league management (), prediction validation (), and new UFA modules (, ). Key integrations include scheduler startup, league coefficient handling in , and  import fix.
-   : Core prediction logic.  now accepts  and .
-   : Manages daily updates. Modified to call the  (formerly ),  from , and  from .
-   : Scrapes league standings.  updated to include new European leagues.
-    (Renamed from ): Now contains all league fetching and coefficient calculation logic for both Phase 1 and Phase 2 leagues, ensuring a single, unified update process.
-    (New): Records real match scores into  for the UFA system.
-    (New): Base for UFA predictions and adjustments. Includes  and  methods.
-    (New): Orchestrates league-specific training, loading real scores, calculating losses, and adjusting priors. Fix included  for subprocess calls.
-    (New): A script to manually trigger UFA training.
-    (New): Analyzes real scores for balance, detecting Unknown ratios, score repetition, and average goals per league. API endpoint  added.
-    (New, v3): Automates real score input via OCR, detects teams/leagues using fuzzy matching, adds to , and immediately triggers UFA training. API endpoint  added.
-    (New): Robust OCR parsing module for extracting match info (scores, teams, league) from images, with fuzzy matching and manual overrides.
-    (New): Script to migrate legacy  data to the new  format, using team names to detect leagues.
-   : Added route for  for UEFA analysis.
-   : UI for league analysis, coefficient display, and prediction validation.
</code_architecture>

<pending_tasks>
The immediate next step, based on the trajectory, is to integrate the new  and  into the main  endpoint in  to ensure robust OCR, team/league detection, and correct coefficient application during predictions.
</pending_tasks>

<current_work>
Immediately before this summary, the AI engineer was addressing a critical issue where league coefficients were not being correctly applied during predictions, specifically in the Analyzer UEFA mode. The problem was diagnosed to be an issue with team and league extraction from the OCR text, resulting in Unknown teams, which prevented coefficient application.

To resolve this, the user provided two new modules:
1.  : This module is designed for robust OCR text processing, capable of extracting scores, detecting team names, and automatically mapping them to leagues using fuzzy matching. It also supports manual overrides for home/away teams and leagues.
2.  : This module provides an integration snippet that leverages  to extract match information, persists detected real scores to the database if available, and then makes predictions by passing the correctly detected league and teams to the predictor, ensuring that coefficients are applied.

The AI engineer has successfully received these two new modules (Chat Message 501) and stated the intention to implement them. This is the direct continuation of resolving the coefficient application problem.
</current_work>

<optional_next_step>
Implement  and  to correctly extract match details and apply coefficients in .
</optional_next_step>
