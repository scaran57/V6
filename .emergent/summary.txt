<analysis>
The AI engineer successfully transformed a basic score prediction backend into a more robust, full-stack application. The development trajectory was highly iterative, driven by user feedback on OCR accuracy and system stability. Initial efforts focused on integrating the core components, establishing API contracts, and addressing basic functionality. The most significant challenge encountered was the inconsistent OCR performance across various bookmaker screenshot formats and themes (light vs. dark), coupled with Tesseract's environmental instability. The AI engineer demonstrated adaptability by first attempting to resolve Tesseract PATH issues, then migrating to EasyOCR (which caused memory issues), and finally implementing a persistent Tesseract installation mechanism. User-provided updates, including a new prediction algorithm and a debug logger, were integrated, enhancing both functionality and observability. The process involved continuous refinement of OCR preprocessing, regex patterns, and score validation logic based on real-world image analysis.
</analysis>

<product_requirements>
The user initially requested a score prediction application capable of processing images from bookmakers. The core problem was to extract match scores and their corresponding odds from screenshots, then use a pre-existing algorithm to predict the most probable score. This started as a personal project, without external users.

Over time, explicit requirements evolved:
- **OCR Robustness:** The primary and most challenging requirement was to make the OCR engine reliable across different bookmakers (Unibet, Winamax), varying display formats (e.g., scores and odds on separate lines, green buttons with white text, table layouts), and themes (light/dark mode). The system needed to filter out extraneous information like time, percentages, and impossible scores.
- **Prediction Algorithm Integration:** The user provided a specific score prediction algorithm (akin to a Kotlin original) involving raw probabilities, Gaussian weighting based on expected difference, and later an improved version with dynamic draw penalty based on odds balance. This needed to be accurately integrated and used.
- **Learning Mechanism:** The application required a learning component to update an expected difference () value based on predicted vs. real scores, with handling for non-numeric scores like Autre.
- **Performance:** The analysis process needed to be efficient, avoiding long processing times and timeouts.
- **Observability:** A debug logging system was requested to monitor the OCR and prediction pipeline.
- **System Stability:** Address issues like Tesseract getting uninstalled or not being found in the PATH after system reboots.
- **Backup:** A mechanism to save the current working version was requested before significant changes.

The implementation so far has built a full-stack application (FastAPI backend, React frontend) that attempts to meet these requirements. The backend exposes endpoints for health checks, image analysis, model learning, and retrieving the expected difference. The frontend provides an interface for image uploads and result display. The OCR engine uses PyTesseract with extensive image preprocessing, pattern matching, and validation. The prediction and learning algorithms are integrated into  and  respectively.
</product_requirements>

<key_technical_concepts>

- **FastAPI:** Python web framework for building the backend API.
- **React:** JavaScript library for building the interactive frontend UI.
- **PyTesseract:** Python wrapper for Google's Tesseract OCR engine, used for text extraction from images.
- **OpenCV (cv2):** Python library for image processing, crucial for preprocessing bookmaker screenshots.
- **PIL (Pillow):** Python Imaging Library, used for image manipulation.
- **Supervisor:** Process control system for managing backend and frontend services.
- **Docker/Docker Compose:** Containerization for environment consistency and deployment.
- **OCR Preprocessing:** Techniques like grayscale, blur, adaptive thresholding, CLAHE, denoising, color channel extraction, inversion for improving text recognition.
- **Regex:** Regular expressions for pattern matching to extract scores and odds.
- **Score Prediction Algorithm:** Custom logic involving odds-to-probability conversion, Gaussian weighting based on score difference, and adaptive draw penalties.
- **Dynamic Learning:** Model adjustment based on real vs. predicted scores.
</key_technical_concepts>

<code_architecture>

The application follows a standard full-stack architecture with a FastAPI backend and a React frontend. It leverages Docker for containerization and Supervisor for process management.

**Directory Structure:**



-   **/app/backend/app/main.py**:
    -   **Importance**: Main FastAPI application entry point, defines API routes (, , , ).
    -   **Changes**:
        -   Initial setup of FastAPI app and routes.
        -   Added relative imports.
        -   Added  for automatic Tesseract installation and configuration.
        -   Integrated  from  into API endpoints.
        -   Modified  endpoint to handle  scores like Autre.
        -   Modified  to return  even if it's Aucune donn√©e.
-   **/app/backend/app/ocr_engine.py**:
    -   **Importance**: Core OCR logic for extracting scores and odds from images.
    -   **Changes**:
        -   Initial implementation for  using .
        -   Fixed relative imports.
        -   Enhanced regex and logic for diverse bookmaker formats.
        -   Added advanced preprocessing using OpenCV () for white text on colored backgrounds.
        -   Introduced score cleaning and validation filters (e.g., ).
        -   Reverted from EasyOCR to PyTesseract after memory issues, re-implementing Tesseract configuration.
        -   Integrated user-provided patch for improved stability (0/O, 1/I distinction, noisy images).
        -   Added specific logic for Unibet format (scores on one line, odds on the next, white text on green).
        -   Implemented automatic image cropping to remove UI elements (time, header).
        -   Integrated  for OCR steps.
-   **/app/backend/app/predictor.py**:
    -   **Importance**: Implements the score prediction algorithm.
    -   **Changes**:
        -   Initial implementation of  using  and Gaussian weighting.
        -   Fixed relative imports.
        -   Integrated user-provided *new calculation algorithm* () which includes dynamic draw penalty and odds balance analysis.
        -   Integrated  for prediction steps.
-   **/app/backend/app/learning.py**:
    -   **Importance**: Handles the adaptive learning mechanism for .
    -   **Changes**:
        -   Initial implementation of  and .
        -   Fixed relative imports.
        -   Modified  to gracefully handle non-numeric  scores (e.g., Autre).
-   **/app/frontend/src/App.js**:
    -   **Importance**: Main React component, user interface for image upload, analysis display, and learning.
    -   **Changes**:
        -   Initial basic UI structure for image upload and displaying results.
        -   Increased API call timeout to handle longer backend processing.
        -   Improved feedback and validation messages for the learning module.
-   **/app/backend/app/debug_logger.py (NEW)**:
    -   **Importance**: Provides a centralized, toggleable logging utility for tracking OCR and calculation pipeline stages.
    -   **Content**: Contains  flag,  function, and  function.
-   **/app/backend/app/DEBUG_GUIDE.md (NEW)**:
    -   **Importance**: Documentation for enabling/disabling the debug mode.
-   **/app/backend/install_tesseract.sh (NEW, but integrated)**:
    -   **Importance**: Script to install Tesseract, initially standalone, then its logic was absorbed into 's startup event for persistence.
-   **/app/backup_working_version_20251104_1520/ (NEW)**:
    -   **Importance**: A snapshot of the working codebase (, , , , ) and a  script, created at user's request.
</code_architecture>

<pending_tasks>
- The immediate pending task is to integrate the  file provided by the user into the backend, which contains a new  function.
</pending_tasks>

<current_work>
Immediately before this summary request, the AI engineer had just received a new Python file, , from the user. This file contains an updated calculation algorithm named , which is intended to replace or enhance the existing prediction logic. The user specified that this file should be placed in the  folder. The AI engineer acknowledged this, stated that a backup of the current working version had been created, and confirmed that it would integrate this new algorithm. The last action in the trajectory was the AI engineer preparing to create this new file and integrate it into the application.
</current_work>

<optional_next_step>
Integrate the user-provided  file into the backend.
</optional_next_step>
